# Elevate Healthcare - Interactive Service Territory Map

Interactive US/Canada map and optimization model for service coverage, travel cost, and hiring scenarios.

- Live map: https://hockeysnipes8989-sudo.github.io/elevate-territory-map/
- Repo: https://github.com/hockeysnipes8989-sudo/elevate-territory-map

## What This Includes

1. Map layers for active-contract assets, appointments, technicians, territories, and airports.
2. Optimization scenario panel on the map for `N=0..4` new hires (all figures annualized).
3. End-to-end MILP pipeline for travel + hiring economics with automatic annualization.
4. Hybrid travel-cost engine built from Navan flight data.
5. BTS-calibrated cost matrix (Step 10) replacing speculative airport benchmarks with government fare data + 1.22× corporate premium.
6. Revenue-from-freed-capacity analysis with three profit-margin tiers.

## Install

```bash
pip install -r requirements.txt
```

Recommended runtime in this environment:

```bash
/opt/miniconda3/bin/python3 ...
```

## Standard Map Pipeline (Steps 1-5)

```bash
python scripts/01_clean_data.py
python scripts/02_geocode.py
python scripts/03_match_install_base.py
python scripts/04_build_territories.py
python scripts/05_generate_map.py
```

Source files for steps 1-4 are expected in `data/raw/`. Geocoding cache lives in `data/geocode_cache.json`.

## Optimization Pipeline (Steps 6-11)

Outputs are written to `data/processed/optimization/`.

```bash
python scripts/06_build_optimization_inputs.py
python scripts/07_build_travel_cost_model.py --engine hybrid --min-direct-route-n 5 --shrinkage-k 10
python scripts/10_correct_travel_costs.py
python scripts/11_build_full_cost_table.py
python scripts/08_optimize_locations.py --min-new-hires 0 --max-new-hires 4 --max-hires-per-base 1 --time-limit-sec 600
python scripts/09_analyze_scenarios.py
python scripts/05_generate_map.py
```

Step 10 (BTS calibration) only needs to re-run when `travel_cost_matrix.csv` changes. Toggle `BTS_CORRECTED_MATRIX` in `scripts/config.py` to switch between matrices without re-running.

Step 10 requires a manually-produced `travel_cost_audit_report.xlsx` in the optimization directory. This file is not generated by any pipeline script.

Step 11 pre-computes a per-(tech/candidate, node) cost table with drive/fly classification, rental car, and hotel costs. Toggle `FULL_COST_MODEL` in `scripts/config.py` to switch between full-cost and flight-only models.

Default external workbook paths are in `scripts/config.py` (overridable via env vars
`ELEVATE_APPTS_SOURCE`, `ELEVATE_TECH_SOURCE`, `ELEVATE_NAVAN_SOURCE`):

- `EXTERNAL_APPOINTMENTS_XLSX`
- `EXTERNAL_TECH_ROSTER_XLSX`
- `EXTERNAL_NAVAN_XLSX`

## Annualization

The appointment dataset spans **2.08 years** (Jan 2, 2024 → Jan 29, 2026, 758 days, 1,480 appointments). The pipeline automatically detects this and annualizes all output figures:

- **Step 06** computes `data_span_years` (2.0753) from the appointment date range and writes it to `optimization_input_summary.json`.
- **Step 08** reads `data_span_years` and scales hire cost to match the data period ($146,640/yr × 2.0753 = $304,322) so the MILP compares travel and hire costs over the same time span.
- **Step 09** divides all period-total costs (travel, hire, overhead) and freed capacity hours by `data_span_years` to produce annual equivalents. All figures in reports and the map are per-year.

This means the MILP solution quality is fully preserved (same solver, same appointments, same optimality) while reported numbers accurately represent one year of operations.

## Current Model Rules (Important)

- Annual burdened planning cost per incremental new hire: `$146,640` (scaled to `$304,322` in MILP to match 2.08-year data period).
- Unmet demand penalty: `$5,000` per appointment (`DEFAULT_UNMET_PENALTY_USD`).
- Out-of-region soft penalty default: `$0.0` (disabled by default).
- Canada coverage rule:
  - Techs flagged `constraint_canada_wide=1` (Hakim policy) are Canada-only.
  - Canada demand nodes can only be assigned to those Canada-wide techs.
  - New hires are blocked from Canada demand in current model.
- Canceled/voided travel handling:
  - Not optimized per scenario.
  - Added as a fixed baseline constant from Navan `Report` tab to every scenario ($35,632 full-period / $17,170 annualized).
- Contractor scope defaults to `texas_only` unless explicitly overridden.
- New-hire concentration cap defaults to `1` per base (`--max-hires-per-base 1`).
- Current verified technician roster is 16 total (including both HTX contractors).
- Technician markers are grouped by shared base location (popup lists all names at that base).
- **New hires cannot serve HPS nodes** — policy constraint (hard variable bound in MILP). 115 HPS appointments served by existing certified techs.

## Travel Cost Engine (Steps 7 + 10)

**Step 7** builds the raw hybrid matrix (`travel_cost_matrix.csv`). Default mode is `--engine hybrid`.

- Inputs: Navan `Clean Flights` + `Report`.
- Training rows: non-management, `TICKETED`, valid origin/destination, positive paid amount.
- Hybrid route estimate logic:
  - Use empirical direct-route information when support is strong.
  - Blend empirical + model prediction using shrinkage for strong direct routes.
  - For sparse routes, blend model prediction with heuristic estimate using support-based weights.
  - Apply guardrails so sparse predictions cannot collapse to unrealistic near-zero fares.
  - Optional BTS prior for low-confidence US gaps.
  - Final fallback to legacy heuristic if needed.
- Diagnostics written:
  - `travel_model_metrics.json`
  - `travel_model_feature_importance.csv`
  - `travel_matrix_coverage_report.json`
  - `bts_prior_coverage_report.json`
  - `travel_matrix_origin_anomaly_report.json`
  - `dropped_zero_fare_flights.csv`

Legacy mode remains available: `--engine heuristic`.

**Step 10** corrects the raw matrix with BTS government fares (`travel_cost_matrix_bts_corrected.csv`).

- Embeds BTS Q2 2025 itinerary fares ÷ 2 × 1.22 corporate premium for 62 US airports + 6 Canadian airports (×2.0 cross-border multiplier).
- Blends BTS benchmarks with Navan actuals by data density (0–4 flights → 80% BTS; 5–9 → 60% BTS; 10–19 → 40% BTS; 20+ → Navan only).
- Per-route override: routes with ≥5 Navan flights use observed actuals directly.
- Audit log written to `cost_correction_log.csv` (one row per origin airport).

## Scenario Cost Formula

Step 8 computes (over the full 2.08-year data period):

- `modeled_total_cost_usd = travel_cost_usd + out_of_region_penalty_usd + hire_cost_usd + unmet_penalty_usd`
- `economic_total_with_overhead_usd = modeled_total_cost_usd + baseline_canceled_voided_usd`

Where:

- `hire_cost_usd = (number of incremental new hires) × $304,322` (annual $146,640 × 2.0753 years)
- `baseline_canceled_voided_usd` is fixed from Navan baseline data ($35,632 full-period)

Step 9 then divides all costs by `data_span_years` (2.0753) to produce annual equivalents shown in reports and the map.

## Latest Baseline Snapshot (Annualized — Current Repo Outputs)

From the latest committed optimization artifacts (BTS-corrected matrix + full cost model + annualization active):

- Data span: **2.0753 years** (Jan 2, 2024 → Jan 29, 2026, 758 days)
- Annualized appointment count: ~713/year (1,480 total)
- Scenario window: `N=0..4`
- Best scenario: `N=0`
- N=0 annualized total: **$620,369** (travel $603,199 + overhead $17,170)
- Hard cap result: no scenario allocates more than 1 hire to the same base
- All 5 scenarios solved to proven optimality (MIP gap = 0.0)
- All 1,480 appointments served across all scenarios (zero unmet)
- Active techs at N=0: 15 (one tech has `availability_fte=0.0`)
- Target utilization: 85% (demand-normalized capacity model)
- Mean utilization at N=0: 85.7%. Max: 99.99%.

### Scenario Results (Annualized)

| N | Annual Travel | Annual Payroll | Annual Overhead | Annual Total |
|---|--------------|----------------|-----------------|-------------|
| 0 | $603,199 | $0 | $17,170 | **$620,369** |
| 1 | $561,056 | $146,640 | $17,170 | $724,866 |
| 2 | $527,987 | $293,280 | $17,170 | $838,437 |
| 3 | $499,597 | $439,920 | $17,170 | $956,687 |
| 4 | $476,761 | $586,560 | $17,170 | $1,080,490 |

All scenarios cost more than N=0. Marginal annual travel savings diminish with each additional hire.

### Revenue-from-Freed-Capacity (Annualized Profit Analysis)

| N | Installs/yr | Net Cost Increase | Net Value (Conservative) | Net Value (Moderate) | Net Value (Aggressive) | Break-Even (Mod) |
|---|------------:|------------------:|-------------------------:|---------------------:|-----------------------:|-----------------:|
| 0 | 0.0 | $0 | $0 | $0 | $0 | 0.0 |
| 1 | 27.3 | $104,497 | $234,043 | $848,329 | $2,759,441 | 3.0 |
| 2 | 54.6 | $218,068 | $459,197 | $1,688,104 | $5,511,373 | 6.2 |
| 3 | 81.9 | $336,318 | $679,348 | $2,522,289 | $8,255,883 | 9.6 |
| 4 | 109.2 | $460,121 | $893,940 | $3,350,905 | $10,994,798 | 13.2 |

Revenue assumptions: Conservative $50K×15%, Moderate $120K×25%, Aggressive $250K×40% margin per install + $7K×70% annual service contract per system. Profit margins applied — figures represent P&L impact, not gross MSRP.

### Hiring Recommendations by Scenario

| N | Recommended Bases |
|---|-------------------|
| 1 | CLE (Cleveland, OH) |
| 2 | CLE, MKE (Milwaukee, WI) |
| 3 | BOS (Boston, MA), ORD (Chicago, IL), CLE |
| 4 | BOS, ORD, CLE, Fort Smith AR (→ LIT airport) |

## Key Caveats

- Hotel cost is flat $399/trip (Navan 2.5-night average). Trip bundling is not modeled.
- Great-circle distance (not road distance) for drive/fly classification at 300 mi threshold.
- No seasonality — all appointments treated equivalently regardless of time of year.
- New hires cannot serve HPS nodes (policy constraint). 115 HPS appointments are served by existing certified techs.
- SHV and ICT travel costs use proxy airports (LIT and TUL respectively), not direct BTS-calibrated values.
- BTS fares are Q2 2025 data. Tier-2 airports (~24 of 68) use estimated midpoints.
- Annualization assumes uniform distribution of costs across the 2.08-year data period.
- Revenue figures represent capacity enabled, not guaranteed bookings. Profit margins (15%/25%/40%) are industry-typical estimates.

## Key Output Files

- `data/processed/optimization/optimization_input_summary.json` — includes `data_span_years`
- `data/processed/optimization/model_assumptions.json` — includes `data_span_years`, `hire_cost_for_optimization_period`
- `data/processed/optimization/tech_master.csv`
- `data/processed/optimization/demand_appointments.csv`
- `data/processed/optimization/candidate_bases.csv`
- `data/processed/optimization/travel_cost_matrix.csv` — raw hybrid model matrix
- `data/processed/optimization/travel_cost_matrix_bts_corrected.csv` — BTS-calibrated matrix (active)
- `data/processed/optimization/full_cost_table.csv` — per-(tech/candidate, node) drive/fly cost table (8,008 rows)
- `data/processed/optimization/cost_correction_log.csv` — per-airport BTS correction audit trail
- `data/processed/optimization/scenario_summary.csv` — raw MILP output (full-period costs)
- `data/processed/optimization/scenario_summary_enhanced.csv` — annualized with revenue analysis
- `data/processed/optimization/scenario_placements.csv`
- `data/processed/optimization/scenario_assignments_existing.csv`
- `data/processed/optimization/scenario_assignments_newhires.csv`
- `data/processed/optimization/scenario_tech_utilization.csv`
- `data/processed/optimization/recommended_hire_locations.csv`
- `data/processed/optimization/analysis_report.json`
- `data/processed/optimization/analysis_report.md`
- `docs/index.html`

## Deeper Documentation

For full context (business rules, caveats, and runbook details), see `CLAUDE.md`.
