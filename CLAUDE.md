# CLAUDE.md — Elevate Healthcare Interactive Service Territory Map

## What This Project Is

This is an interactive web map built for **Elevate Healthcare** (client: Shannon). The original request was to overlay install base data (where their patient simulation equipment lives) on top of Abhi's territory map — so the team can visualize where active-contract simulators are concentrated, how well service territories are covered, where technicians are located, and which accounts are hard or expensive to reach.

The map is a self-contained HTML file generated by a Python pipeline and served on **GitHub Pages**.

**Live map:** https://hockeysnipes8989-sudo.github.io/elevate-territory-map/

**GitHub repo:** https://github.com/hockeysnipes8989-sudo/elevate-territory-map

---

## Tech Stack

- **Python 3** — all pipeline scripts
- **Folium** (Python → Leaflet.js) — generates a single self-contained HTML file with no API key needed
- **geopy + Nominatim** — free geocoding for city/state pairs, results cached to JSON
- **fuzzywuzzy** — fuzzy account name matching between install base and appointment records
- **pandas** — all data wrangling
- **openpyxl** — reading `.xlsx` Excel source files
- **GitHub Pages** — serves `docs/index.html` from the `main` branch

---

## Project Structure

```
elevate-territory-map/
├── scripts/
│   ├── config.py                          # All paths, colors, constants, airport data
│   ├── 01_clean_data.py                   # Load Excel → clean CSVs
│   ├── 02_geocode.py                      # Geocode city/state pairs → lat/lon
│   ├── 03_match_install_base.py           # Match install base accounts to appointment locations
│   ├── 04_build_territories.py            # Build territory GeoJSON from US state boundaries
│   └── 05_generate_map.py                 # Generate docs/index.html (the actual map)
├── data/
│   ├── raw/                               # Source Excel files — GITIGNORED, must be present locally
│   │   ├── UIUC service appointments with dipsatch date - final.xlsx
│   │   ├── Service Appointments report - final.xlsx
│   │   └── Install Base (all patient sim assets) - final.xlsx
│   ├── processed/                         # All intermediate CSVs and GeoJSON — committed
│   │   ├── service_appointments_clean.csv
│   │   ├── technicians.csv
│   │   ├── install_base_clean.csv
│   │   ├── appointments_geocoded.csv
│   │   ├── technicians_geocoded.csv
│   │   ├── install_base_matched.csv       # Active-contract assets with matched coordinates
│   │   ├── install_base_all_matched.csv   # All assets (active + non-active) with matching
│   │   ├── install_base_nonactive_matched.csv
│   │   ├── territory_summary.csv          # Per-territory asset counts
│   │   ├── territories.geojson            # Territory boundary polygons (real US state outlines)
│   │   ├── us-states.json                 # Cached US state GeoJSON (downloaded once)
│   │   └── canada.geojson                 # Cached Canada provinces GeoJSON (downloaded once)
│   └── geocode_cache.json                 # 484 cached lat/lon lookups — DO NOT DELETE
├── docs/
│   └── index.html                         # THE MAP — generated output, served by GitHub Pages
├── requirements.txt
├── README.md
└── CLAUDE.md                              # This file
```

---

## CRITICAL: When to Re-Run Which Scripts

**The most important rule in this project:**

> **In almost all cases, only re-run `scripts/05_generate_map.py`.** The processed CSVs and GeoJSON in `data/processed/` are already correct and committed. Re-running earlier steps unnecessarily risks corrupting the geocode cache or losing validated match data.

### Re-run guide:

| What changed | Scripts to re-run |
|---|---|
| Map layer appearance, colors, popups, layer names | `05_generate_map.py` only |
| Adding new map layers (e.g., airport hubs) | `05_generate_map.py` only |
| New airports or config constants added | `05_generate_map.py` only |
| Source Excel files updated with new appointments | `01` → `02` → `03` → `04` → `05` |
| New accounts need to be fuzzy-matched | `03` → `04` → `05` |
| Territory boundary definitions changed | `04` → `05` |
| `GEOCODE_OVERRIDES` changed in config.py | `02` → `03` → `04` → `05` |

**Never re-run `02_geocode.py` casually.** It makes live Nominatim API calls with a 1.1-second delay per lookup (~8 minutes for 484 entries). All lookups are already cached and manually validated in `data/geocode_cache.json`.

---

## The Five Pipeline Scripts

### `scripts/config.py` — Central Configuration

All constants live here. Key things:
- **File paths** — all input/output paths defined as constants
- **`TECH_NAME_MAP`** — maps name variants in the Excel to canonical names (e.g., `"Clarence Bonner, Jr"` → `"Clarence Bonner"`)
- **`TECH_STATUS`** — 10 active, 3 former (David Bazany, John Aleksa, Trent Osborne), 3 special (Alex Rondero, Damion Lyn, Elier Martin)
- **`TERRITORY_COLORS`** — 19 distinct hex colors for territory boundary polygons
- **`CHOROPLETH_COLORS`** — 5-color gradient `#ffffb2` (light yellow) → `#bd0026` (dark red) for active asset density
- **`SERVICE_TYPE_COLORS`** — PM=blue, Repair=red, Install=green, Other=purple
- **`GEOCODE_OVERRIDES`** — deterministic lat/lon fixes applied every time geocoding runs (fixes typos like "Pheonix, AZ", ambiguous lookups like "Ontario, CA" vs Ontario Canada, and 6 misspelled cities)
- **`MAJOR_AIRPORTS`** — list of 65 US + Canada airports for the travel optimization layer
- **`MAP_CENTER`** = `[39.8283, -98.5795]` (geographic center of contiguous US), `MAP_ZOOM` = 4
- **`MAP_TILES`** = `"CartoDB positron"` (clean light gray basemap, no API key)

### `scripts/01_clean_data.py` — Load & Clean Excel

Reads the 3 raw Excel files and outputs clean CSVs. Key details:
- Strips leading dots from city names (artifact in source data)
- Normalizes technician names via `TECH_NAME_MAP`
- Builds `geocode_key` column (e.g., `"Chicago, IL, USA"`) for geocoding — does NOT overwrite `State/Province` column with abbreviations (raw values preserved)
- Flags install base assets as `has_active_contract` based on `Contract_Status_Clean` column

**Sheet names:**
- Appointments: `"Derived Fields"` from `UIUC service appointments with dipsatch date - final.xlsx`
- Technicians: `"Resources"` from `Service Appointments report - final.xlsx`
- Install base: `"report1769446081737"` from `Install Base (all patient sim assets) - final.xlsx`

### `scripts/02_geocode.py` — Geocode City/State Pairs

Geocodes unique city/state pairs from appointments and technician home bases via Nominatim. Key details:
- 1.1-second delay between API calls (Nominatim rate limit)
- All results cached in `data/geocode_cache.json` — subsequent runs skip already-cached keys
- `apply_overrides()` runs on every execution to enforce `GEOCODE_OVERRIDES`
- 484 unique keys currently cached, 1480/1480 appointments geocoded (100%), 16/16 technicians geocoded

**Do not delete `data/geocode_cache.json`.** It contains 484 manually validated entries including hand-corrected coordinates for typos, misspellings, and ambiguous locations.

### `scripts/03_match_install_base.py` — Match Install Base to Locations

The install base Excel has no city/state — only Account Name and Territory. This script matches install base accounts to service appointment accounts (which do have coordinates) using 3-stage matching:

1. **Exact match** — case-insensitive exact string match on Account Name
2. **Manual match** — explicit alias dictionary `MANUAL_ACCOUNT_MAP` for known name variants (e.g., `"Sarasota Memorial Hospital"` → `"Sarasota Memorial Hospital-Venice Campus"`)
3. **Fuzzy match** — `fuzz.ratio()` within same territory, threshold = 92 (high confidence only)

**`FUZZY_REJECT_PAIRS`** — set of known false-positive pairs that get explicitly blocked (e.g., `"lenoir community college"` / `"owens community college"` — similar names, different states).

**Current match results:**
- Active-contract assets: 2,000 / 3,087 matched (64.8%)
- Non-active assets: 1,825 / 5,441 matched

The 35% of active assets without coordinates are aggregated at territory level in the choropleth — they still appear in the count, just not as individual point markers.

### `scripts/04_build_territories.py` — Build Territory GeoJSON

Builds territory boundary polygons using real US state outlines (not convex hulls — convex hulls were replaced because they created ugly triangular shapes and included outlier locations like USVI in the polygon calculation).

Key details:
- Downloads US state GeoJSON from PublicaMundi and Canada provinces from codeforamerica — both cached to `data/processed/` on first run
- **`TERRITORY_TO_US_STATES`** dict maps each of the 19 territories to state abbreviations
- Wyoming (WY) is in West Plains — it was missing initially, causing a white gap on the map
- Alaska is rendered as an outlier point marker (not a polygon) to avoid distorting the map view
- Canada is limited to 5 provinces with actual data: Ontario, Alberta, Saskatchewan, Quebec, British Columbia

### `scripts/05_generate_map.py` — Generate the Map

The main script. Creates a Folium map and saves it to `docs/index.html`. **This is the only script that needs to run for most changes.**

Current map layers (in render order):
1. **Active Contract Simulators** (`show=True`) — territory choropleth colored by asset count + point markers for matched accounts
2. **Non-Active/No Contract Assets** (`show=True`) — gray circle markers for assets without active contracts
3. **Service Appointments** (`show=True`) — 1,480 individual `CircleMarker` dots, radius=3, color-coded by service type
4. **Technician Home Bases** (`show=True`) — 16 Font Awesome icon markers (green=active, gray=former, orange=special)
5. **Territory Boundaries** (`show=True`) — 19 semi-transparent GeoJSON polygons with outlier point markers for AK/HI/USVI
6. **Major Airport Hubs (65)** (`show=True`) — dark blue plane icons at 65 US + Canada airports
7. **Hub Dispatch Radius (~300mi / 5hr drive)** (`show=False`) — light blue circles around 15 key hub airports

All layers are toggleable via `folium.LayerControl(collapsed=False)`.

---

## Map Layers — Detailed Reference

### Active Contract Simulators
- **Choropleth** — territory polygons filled with a 5-color gradient (light yellow = fewest active assets, dark red = most)
- **Point markers** — orange/red `CircleMarker` for each account that matched to appointment coordinates. Radius scales with asset count (min 4, max 15). Click for account name, territory, asset count, product families.
- **Ground truth counts:** 3,087 total active assets across 19 territories. Largest: North Florida (380), Carolinas/Virginias (357), Great Lakes (320).

### Service Appointments
- 1,480 individual dots (no clustering). Radius=3, opacity=0.7.
- Colors: PM=blue (484), Repair=red (427), Install=green (378), Other=purple (191)
- Click for appointment number, type, tech name, territory, date, subject

### Technician Home Bases (16 total)
- **Active (10):** Ben Walker, Bladimir Torres, Clarence Bonner, Eric Olinger, Hector Arias, James Sanchez, Josh Brown, Robert Cohen, Scott Fogo, Tameka Gongs
- **Former (3):** David Bazany, John Aleksa, Trent Osborne
- **Special/Contractor (3):** Alex Rondero, Damion Lyn, Elier Martin

### Major Airport Hubs
- 65 airports covering all major US regions + 6 Canadian airports (YYZ, YUL, YYC, YEG, YVR, YQR)
- Dark blue plane icon using `folium.Icon(color="darkblue", icon="plane", prefix="fa")` — `prefix="fa"` is required for Font Awesome icons
- Specifically includes BIS (Bismarck ND), BIL (Billings MT), FAR (Fargo ND) — flagged by client as hard-to-reach locations
- Defined in `config.MAJOR_AIRPORTS` — each entry has `code`, `name`, `city`, `lat`, `lon`

### Hub Dispatch Radius
- **Business rule:** If a tech can drive to an account in ≤5 hours, they drive. If not, they fly.
- **Radius:** 483,000 meters (~300 miles, assuming ~60 mph average highway speed)
- **15 key hubs with circles:** ATL, ORD, DFW, DEN, LAX, JFK, SFO, SEA, MIA, BOS, PHX, IAH, MSP, CLT, SLC
- Light blue fill, opacity=0.04 (very subtle), weight=1.5 border
- Layer defaults to `show=False` — user toggles it on when needed

---

## Known Edge Cases & Important Notes

### Geocoding Gotchas (already fixed in `GEOCODE_OVERRIDES`)
- `"Pheonix, AZ"` — misspelling was geocoding to Massachusetts (~42°N). Fixed to `(33.4484, -112.0741)`.
- `"Ontario, CA"` — Josh Brown's home base. Nominatim was returning Ontario, Canada. Pinned to `(34.0658, -117.6484)` (Ontario, California).
- `"London, Ontario, Canada"` — must use full `"London, Ontario, Canada"` key or Nominatim returns London, England.
- 6 other misspelled cities manually corrected in cache.

### Territory Boundary Issues (already fixed)
- Wyoming was missing from all territory definitions → white gap on map. Fixed by adding WY to West Plains.
- Canada originally rendered all 279 province polygons → dominated the map. Fixed by limiting to 5 provinces with actual data.
- South Florida boundary originally stretched to USVI → convex hull artifact. Fixed by treating USVI as an outlier point marker.
- Alaska polygon distorted the whole map. Fixed by rendering Alaska as a point marker at `(64.2008, -149.4937)`.

### Install Base Matching Notes
- The install base has no city/state data — coordinates come entirely from matching account names to service appointment accounts.
- Fuzzy matching threshold is 92 (not 100, not 85). It was tightened from 85 to 92 after false positives were identified (e.g., "Lenoir Community College" matching "Owens Community College" — similar token patterns, different states).
- When adding new manual aliases, add them to `MANUAL_ACCOUNT_MAP` in `03_match_install_base.py`.
- When blocking a new fuzzy false positive, add the normalized lowercase tuple to `FUZZY_REJECT_PAIRS`.

### Service Appointment Markers
- MarkerCluster was intentionally removed. All 1,480 appointments are shown as individual dots. This was a deliberate client preference — they wanted to see the full density immediately without needing to zoom in.

---

## How to Run

```bash
# Install dependencies (one time)
pip install -r requirements.txt

# Almost always, only this is needed:
cd /Users/patricklipinski/elevate-territory-map
python3 scripts/05_generate_map.py

# Full pipeline from scratch (only if raw Excel changed):
python3 scripts/01_clean_data.py
python3 scripts/02_geocode.py          # Takes ~8 min on first run
python3 scripts/03_match_install_base.py
python3 scripts/04_build_territories.py
python3 scripts/05_generate_map.py
```

Expected output from `05_generate_map.py`:
```
Map saved: .../docs/index.html
File size: ~3.7 MB
Step 5 complete.
```

If file size exceeds 10 MB, something is wrong (likely a rendering loop or duplicate layer).

---

## Deployment

The map deploys automatically to GitHub Pages when changes are pushed to `main`. No build step required — GitHub Pages serves `docs/index.html` directly.

```bash
git add scripts/config.py scripts/05_generate_map.py docs/index.html
git commit -m "Description of what changed"
git push origin main
```

GitHub Pages URL: https://hockeysnipes8989-sudo.github.io/elevate-territory-map/

Allow 1-2 minutes after push for Pages to update.

---

## Outstanding Work (Shannon's Requests)

The following items from the client meeting have not yet been implemented:

- **2025-only filtered analysis** using the "request covered by support maintenance" field
- **Repeat repair within 60 days metric** — Shannon was going to send her Excel with this data
- **Technician certification overlay** — Isabel was sending a certification list per product type
- **Flight cost / travel optimization analysis** — ~$1.1M annual travel budget, Navan data
- **Hard-to-reach location flagging** — Durango CO, Bismarck ND, Montana specifically called out by client as high-cost dispatch locations
